---
title: "State tax revenue volatility"
author: "Don Boyd"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_notebook: 
    df_print: paged
    fig_height: 6
    fig_width: 8
    toc: yes
    toc_float: yes
    number_sections: yes
  html_document:
    toc: yes
    toc_depth: '3'
    df_print: paged
editor_options:
  chunk_output_type: console
---

# PROJECT MANAGEMENT

```{r runall, eval=FALSE, echo=FALSE}
# Pew folks - please pay no attention to this chunk.

# When we want a final report, run the following code selectively "by hand" (interactively)
# -- NEVER using Knit with eval=TRUE
# note <br> breaks line for html output but \n should break for pdf; also could try |

# uncomment these next 3 lines
# rmdfn <- "./Pew_Tax_Revenue_Volatility.rmd" # this file
# outfn <- paste0("tax_volatility_", format(Sys.time(), "%Y-%m-%d"), ".html")
# rmarkdown::render(rmdfn, output_format="html_document", output_file=outfn)

# library(RCurl)
# ftpUpload(outfn, "ftp://kffrig:boyd4812@files.000webhost.com/public_html/KFF_RIG_MedicaidCuts_new.html")

# Note may be safest to fully exit RStudio and restart it before running whole thing. Otherwise knitr may get confused
# and include repetitive information in the output html file.

```


Note: The following list of figures and maps, and the list of tables, are in the order in which they appear in:

Boyd_StateTaxRevenueVolatility_Report_2022_2022-03-08.docx 

However, the actual figure and table numbering in that document does not match the numbering below because I forgot to force an update of numbering before I submitted the document. If you force renumbering in the Word doc (ctrl-A, then F9), its new numbering will match what you see below.

In the code below I have tried to make each figure and table appear in the order in which they appear in the Word doc, but they may not be perfectly synchronized.

## Figures and maps

1.  fig_tax_gdp_us

2.  fig_trend_cycle_random

3.  fig_caiit_3panel

4.  fig_NY_real_iit_gdp

5.  fig_ustax_trend_actual [Mar 8 draft misnumbered this and following]

6.  fig_ustax_pdtrend

7.  fig_pdtrend_taxgdp_box

8.  fig_all_pdtrend

9.  fig_pdtrend_taxtype_box

10. fig_pi_agi

11. fig_iit_sources_2panel

12. fig_capgains_agi

13. map_decades_pdtrendiqr

14. fig_pdtrend_taxtype_decades_box

15. fig_pdtrend_decades_taxtype_box

16. map_recessions_pdtrendiqr

17. fig_pdtrend_recessions_taxtype_box

18. fig_eff_taxes_us

19. fig_eff_states

20. fig_pdtrend_box

21. fig_pdtrend_taxgdp_scatter_decades

## List of tables

1.  tab_agi2009

2.  tab_rec_features

3.  tab_recession_nonrecession

4.  tab_states_vol

# LOAD OPTIONS, LIBRARIES, FUNCTIONS, CONSTANTS

This section doesn't produce any output other than some informational messages.

## Preliminaries

```{r setup, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
knitr::opts_chunk$set(include=FALSE, eval=TRUE,
                      echo=FALSE, message = FALSE, warning = FALSE)

# opts_chunk is a merger of local options and default options
# opts_current is the current chunk's options - from within any given chunk
# knitr::opts_chunk$get()  # copy to console to get proper list of options
# knitr::opts_current$get()
str(knitr::opts_chunk$get()) # for a list of default chunk options.

# renv::status()
# renv::snapshot() 

```

# Libraries and functions

```{r get_libs, eval=TRUE}
rm(list=ls(all=TRUE)) # clear objects from the workspace
source(here::here("r", "libs_base.r"))
source(here::here("r", "libs_ts.r"))
devtools::session_info()
# devtools::package_info()
# knitr::opts_current$get()

```

# Constants

```{r system_specific}
source(here::here("r", "constants_system.r"))

```

```{r constants_other, eval=TRUE}
# Constants, themes, etc.
source(here::here("r", "constants_analysis.r"))

#.. source notes ----
source_acs <- "American Community Survey 5-year summary file"
source_bea <- "U.S. Bureau of Economic Analysis"
source_boyd <- "Illustrative data constructed by author, as described in the text"
source_census <- "U.S. Bureau of the Census"
source_cbo <- "U.S. Congressional Budget Office"
source_decennialpop <- "U.S. Census Bureau Decennial Census"
source_soi <- "IRS Statistics of Income"
source_tpc <- "IRS Statistics of Income via https://www.taxpolicycenter.org"

```

# Functions

```{r get_functions}
source(here::here("r", "functions", "functions_maps.r"))
source(here::here("r", "functions", "functions_measures.r"))
source(here::here("r", "functions", "functions_plots.r"))
source(here::here("r", "functions", "functions_runs.r"))
source(here::here("r", "functions", "functions_utility.r"))

```

```{r more_functions, eval=TRUE}
# renv::snapshot() 

```

# LOAD AND PREPARE DATA

## Load previously created data

```{r get_data, include=FALSE, eval=TRUE}
# load(file = here::here("data", "general.RData"), verbose=TRUE)
# load(file = here::here("data", "econ_national.RData"), verbose=TRUE)
# load(file = here::here("data", "gdp_state.RData"), verbose=TRUE)
# load(file = here::here("data", "qcew_state.RData"), verbose=TRUE)

load(file = here::here("data", "taxdata.RData"), verbose=TRUE)
load(file = here::here("data", "capgainsagi.RData"), verbose=TRUE)
load(file = here::here("data", "recession_features.RData"), verbose=TRUE)


```

```{r get_voldata}
# previously prepared volatility data
vbase <- readRDS(here::here("data", "vbase.rds"))
volall <- readRDS(here::here("data", "volall.rds"))
volrecs <- readRDS(here::here("data", "volrecs.rds"))

```

# END OF PREP, START OF ANALYSIS

# 1. INTRODUCTION - MOTIVATION

```{r fig_tax_gdp_us.png, fig.height=4.5, fig.width=8, eval=TRUE, include=TRUE}
# sd10c
#  pchplot, fig.height=4.5, fig.width=8, eval=FALSE}
# summary(sgtax.a)

pdata <- vbase %>%
  filter(year >= 1960, 
         name %in% c("tottax", "gdp"), 
         realnom=="nominal", 
         stabbr=="US") %>%
  select(stabbr, year, name, realnom, year, pch) %>%
  mutate(namef=factor(name,
                      levels=c("tottax", "gdp"),
                      labels=c("Taxes", "GDP")))
summary(pdata)

p <- pdata %>%
  ggplot(aes(year, pch, colour=namef)) +
  geom_band(recdata(unique(pdata$year))) +
  geom_line(size=1) +
  geom_point(size=1.15) +
  scale_y_continuous(name="% change",
                     breaks=seq(-2, 2, .02), 
                     labels=label_percent(accuracy=1)) +
  scale_x_continuous(name=NULL, breaks=seq(1960, 2030, 5)) +
  scale_colour_manual(values=bluegreen) +
  geom_hline(yintercept = 0) +
  ggtitle("State government tax revenue and gross domestic product (GDP) for the United States",
          subtitle="Percent change versus year earlier") +
  labs(caption="Note: Recession periods are shaded.\nSources: U.S. Bureau of the Census and Bureau of Economic Analysis") +
  theme_bw() +
  theme(plot.caption = element_text(hjust=0, size=9)) +
  theme(legend.title = element_blank())
p

savefig(basename="fig_tax_gdp_us")

```

# 2. HOW SHOULD WE MEASURE VOLATILITY?

## Alternative volatility measures with made-up data

```{r volatile_data}
set.seed(33)  
# 15 best so far
# 12 some long negatives -- rand much more vol w/pchsd
# 1234 a little too uniform
# 4 quite good
# 14 pretty good
# 28 very good

# create data with different kinds of volatility
nyears <- 30
time <- 0:(nyears - 1)
grate <- .03
init <- 100
trend <- init * (1 + grate)^time
nturns <- 6
x <- seq(0, 1, length.out = nyears)
sinx <- sin(nturns * pi * x)
# plot(sinx)

(noise_prop <- c(0, rnorm(nyears - 1, mean=0, sd=.075)))
cycle_size <- .1
mud <- tibble(time=time) %>%
  mutate(trend=trend, 
         cycle=trend * (1 + sinx * cycle_size),
         cycle=cycle * sum(trend) / sum(cycle),
         random=trend * (1 + noise_prop),
         random=random * sum(trend) / sum(random))

mud %>% summarise(across(c(trend, cycle, random), sum))
mud %>% summarise(across(c(trend, cycle, random), sd))
mud %>% 
  mutate(rdtrend = (random - trend) / trend,
         cdtrend = (cycle - trend) / trend) %>%
  summarise(across(c(trend, cycle, random, rdtrend, cdtrend), sd))

mud %>% 
  mutate(rdtrend = (random - trend) / trend,
         cdtrend = (cycle - trend) / trend) %>%
  summarise(across(c(trend, cycle, random, rdtrend, cdtrend), mean))

mud %>% 
  mutate(ardtrend = abs((random - trend) / trend),
         acdtrend = abs((cycle - trend) / trend)) %>%
  summarise(across(c(trend, cycle, random, ardtrend, acdtrend), mean))

```

```{r tab_randcycle_stats}
mud %>% 
  summarise(across(c(trend, cycle, random), sd))

mud_long <- mud %>%
  pivot_longer(-time) %>%
  group_by(name) %>%
  mutate(pch=value / value[match(time - 1, time)] - 1) %>%
  group_by(time) %>%
  mutate(pdtrend=value / value[name=="trend"] - 1) %>%
  ungroup

mud_long %>% 
  filter(time >= 1, name != "trend") %>%
  mutate(name=factor(name, levels=c("random", "cycle"))) %>%
  group_by(name) %>%
  summarise(across(c(pch, pdtrend), sd))

```

```{r madeup_data}

# create long version of made-up data
pdata <- mud %>%
  pivot_longer(-time) %>%
  group_by(name) %>%
  mutate(pch=value / value[match(time - 1, time)] - 1) %>%
  group_by(time) %>%
  mutate(pdtrend=value / value[name=="trend"] - 1) %>%
  ungroup

pdata
max(abs(pdata$pch), na.rm=TRUE)
max(pdata$pch, na.rm=TRUE)
min(pdata$pch, na.rm=TRUE)

pdata %>%
  filter(name=="cycle")

pdata %>%
  filter(name=="random")

pdata %>% 
  group_by(name) %>% 
  summarise(across(c(value, pch, pdtrend), 
                   list(mean=~mean(.x, na.rm=TRUE),
                        min=~min(.x, na.rm=TRUE),
                        max=~max(.x, na.rm=TRUE))))
```

## Random and cyclical fluctuation

```{r fig_trend_cycle_random, eval=TRUE, include=TRUE}

colors = c("black", "blue")

# levels
p1 <- pdata %>%
  filter(name %in% c("trend", "random")) %>%
  mutate(name=factor(name, levels=c("trend", "random"))) %>%  # to get right sort order
  ggplot(aes(time, value, colour=name)) +
  geom_line() +
  geom_hline(yintercept = 100) +
  scale_y_continuous(name="$ revenue", limits=c(90, 265), labels=scales::dollar) +
  scale_x_continuous(name="year", breaks=seq(0, 40, 5), limits=c(0, 32)) +
  scale_colour_manual(values=colors) +
  ggtitle("Random revenue fluctuations",
          subtitle="Annual amount of revenue") +
  theme_report +
  legend_notitle
p1

# percent change
p2 <- mud_long %>%
  filter(name %in% c("trend", "random")) %>%
  mutate(name=factor(name, levels=c("trend", "random"))) %>%  # to get right sort order
  ggplot(aes(time, pch, colour=name)) +
  geom_line() +
  geom_hline(yintercept = 0, colour="grey") +
  scale_y_continuous(name="% change", 
                     breaks=seq(-.5, .5, .1),
                     limits=c(-.3, .3), 
                     labels=scales::percent_format(accuracy=1)) +
  scale_x_continuous(name="year", breaks=seq(0, 40, 5), limits=c(0, 32)) +
  scale_colour_manual(values=colors) +
  ggtitle("Random revenue fluctuations",
          subtitle="Annual percent change") +
  theme_report +
  legend_notitle
p2

# % diff from trend
p3 <- mud_long %>%
  filter(name=="random") %>%
  mutate(posneg=ifelse(pdtrend < 0, "neg", "pos")) %>%
  ggplot(aes(time, pdtrend)) +
  geom_hline(yintercept = 0) +
  geom_bar(stat = "identity", aes(fill = posneg)) + 
  scale_fill_manual(values=rev(bluered)) +
  scale_x_continuous(name="year", breaks=seq(0, 40, 5), limits=c(0, 32)) +
  scale_y_continuous(name="% difference from trend",
                     breaks=seq(-.2, .2, .05), 
                     labels=scales::percent_format(accuracy=1),
                     limits=c(-.2, .2)) +
  ggtitle("Random revenue fluctuations",
          subtitle="Percent difference from trend") +
  theme_report +
  legend_none
p3


p123 <- p1 / p2 / p3
p123
# ggsave(filename = here::here("results", "trend_random_3panel.png"), plot = p123, width=8, height=8)

# Cyclical variation

# levels
p4 <- mud_long %>%
  filter(name %in% c("trend", "cycle")) %>%
  mutate(name=factor(name, levels=c("trend", "cycle"))) %>%
  ggplot(aes(time, value, colour=name)) +
  geom_line() +
  geom_hline(yintercept = 100) +
  scale_y_continuous(name="$ revenue", limits=c(90, 265), labels=scales::dollar) +
  scale_x_continuous(name="year", breaks=seq(0, 40, 5), limits=c(0, 32)) +
  scale_colour_manual(values=colors) +
  ggtitle("Cyclical revenue fluctuations",
          subtitle = "Annual amount of revenue") +
  theme_report +
  legend_notitle
p4

# percent change
p5 <- mud_long %>%
  filter(name %in% c("trend", "cycle")) %>%
  mutate(name=factor(name, levels=c("trend", "cycle"))) %>%  # to get right sort order
  ggplot(aes(time, pch, colour=name)) +
  geom_line() +
  geom_hline(yintercept = 0, colour="grey") +
  scale_y_continuous(name="% change", 
                     breaks=seq(-.5, .5, .1),
                     limits=c(-.3, .3), 
                     labels=scales::percent_format(accuracy=1)) +
  scale_x_continuous(name="year", breaks=seq(0, 40, 5), limits=c(0, 32)) +
  scale_colour_manual(values=colors) +
  ggtitle("Cyclical revenue fluctuations",
          subtitle = "Annual percent change") +
  theme_report +
  legend_notitle
p5

# % diff from trend
p6 <- mud_long %>%
  filter(name=="cycle") %>%
  mutate(posneg=ifelse(pdtrend < 0, "neg", "pos")) %>%
  ggplot(aes(time, pdtrend)) +
  geom_hline(yintercept = 0) +
  geom_bar(stat = "identity", aes(fill = posneg)) + 
  scale_fill_manual(values=rev(bluered)) +
  scale_x_continuous(name="year", breaks=seq(0, 40, 5), limits=c(0, 32)) +
  scale_y_continuous(name="% difference from trend",
                     breaks=seq(-.2, .2, .05), 
                     labels=scales::percent_format(accuracy=1),
                     limits=c(-.2, .2)) +
  ggtitle("Cyclical revenue fluctuations",
          subtitle="Percent difference from trend") +
  theme_report +
  legend_none
p6

p456 <- p4 / p5 / p6

p456
# ggsave(filename = here::here("results", "trend_cycle_3panel.png"), plot = p456, width=8, height=8)

p7 <- p123 | p456
p7


p123 +
  labs(caption=paste0("Source: ", source_boyd))

p456 +
  labs(caption=paste0("Source: ", source_boyd))


p8 <- p7 +
  plot_annotation(caption = paste0("Source: ", source_boyd),
                  theme = theme(plot.caption=element_text(hjust=0, size=9)))
p8

# p8 <- p7 +
#   plot_annotation(
#   title = 'The surprising truth about mtcars',
#   subtitle = 'These 3 plots will reveal yet-untold secrets about our beloved data-set',
#   caption = 'Disclaimer: None of these plots are insightful'
#   )
# p8

# ggsave(filename = here::here("results", "fig_trend_cycle_random.png"),
#        plot = p7, width=8, height=8, scale=1)

savefig(basename="fig_trend_cycle_random", .p=p8, .pdata=pdata,
        width=8, height=8)

```

## State examples

## 3-panel graph

```{r fig_caiit_3panel}

caiit <- vbase %>%
  filter(stabbr=="CA", name=="iit", realnom=="nominal", year %in% 1975:2005) %>%
  prep_3panel()

p <- panel3(caiit, "California income tax revenue", scale=1e6, scaled_units="$ billions")
p

p2 <- p +
  plot_annotation(caption = paste0("Source: ", source_census),
                  theme = theme(plot.caption=element_text(hjust=0, size=9)))

savefig(basename="fig_caiit_3panel", .p=p2, .pdata=caiit,
        width=8, height=8)

# ggsave(filename = here::here("results", "fig_caiit_3panel.png"),
#        plot = p, width=8, height=8, scale=1)

```

```{r fig_NY_real_iit_gdp}

pdata <- vbase %>%
  filter(year %in% 1990:2019, 
         stabbr=="NY", name %in% c("iit", "gdp"), 
         realnom=="real") %>%
  group_by(stabbr, name, realnom) %>%
  arrange(year) %>%
  mutate(namef=factor(name, 
                     levels=c("iit", "gdp"), 
                     labels=c("Income tax", "State GDP")))

p <- pdata %>%
  ggplot(aes(year, pch, colour=namef)) +
  geom_band(recdata(unique(pdata$year))) +
  geom_line(size=1) +
  geom_point(size=1.15) +
  scale_y_continuous(name="% change",
                     breaks=seq(-2, 2, .02), 
                     labels=label_percent(accuracy=1)) +
  scale_x_continuous(name=NULL, breaks=seq(1960, 2030, 5)) +
  scale_colour_manual(values=bluegreen) +
  geom_hline(yintercept = 0) +
  ggtitle("Percent change in inflation-adjusted NY income tax revenue and state GDP, versus year earlier",
          subtitle="Recession periods are shaded") +
  labs(caption="Source: U.S. Bureau of the Census and Bureau of Economic Analysis") +
  theme_bw() +
  theme(plot.caption = element_text(hjust=0, size=9)) +
  theme(legend.title = element_blank())
p 
savefig(basename="fig_NY_real_iit_gdp")

```


## Policy changes
```{r eval=FALSE}
glimpse(vbase)
count(vbase, name)

# the Pew years are 1995    2014

iittmp <- vbase %>%
  filter(realnom=="nominal", 
         name %in% c("iit", "iitpew"),
         year %in% 1995:2014,
         !(is.na(pch))) %>%
  select(stabbr, name, year, pch)

# iittmp %>%
#   group_by(name) %>%
#   summarise(minyear=min(year), maxyear=max(year))

iittmp %>%
  filter(!stabbr %in% c("US", "NH", "TN")) %>%
  ggplot(aes(year, pch, colour=name)) +
  geom_point() +
  geom_line() +
  facet_wrap(~stabbr, ncol=6, scales = "free")

iittmp %>%
  filter(!stabbr %in% c("US", "NH", "TN")) %>%
  pivot_wider(values_from = pch) %>%
  mutate(diff=iitpew - iit) %>%
  arrange(-abs(diff)) %>%
  slice_head(n=5)

  
#.....................................................

gsttmp <- vbase %>%
  filter(realnom=="nominal", 
         name %in% c("gst", "gstpew"),
         year %in% 1995:2014,
         !(is.na(pch))) %>%
  select(stabbr, name, year, pch)

# gsttmp %>%
#   group_by(name) %>%
#   summarise(minyear=min(year), maxyear=max(year))

gsttmp %>%
  # filter(!stabbr %in% c("US", "NH", "TN")) %>%
  ggplot(aes(year, pch, colour=name)) +
  geom_point() +
  geom_line() +
  facet_wrap(~stabbr, ncol=6, scales = "free")

gsttmp %>%
  filter(!stabbr %in% c("US")) %>%
  pivot_wider(values_from = pch) %>%
  mutate(diff=gstpew - gst) %>%
  arrange(-abs(diff)) %>%
  slice_head(n=5)


# What were the volality measures
glimpse(volall)
count(volall, period)

```


## Inflation and rankings
```{r fig_realnom_states, eval=FALSE}
glimpse(volall)
# count(volall, realnom)
# count(volall, period)

pd <- "1970-2020"
pd <- "2000-2020"
pdata <- volall %>%
  filter(name=="tottax", period==pd) %>%
  filter(!is.na(pdtrendiqr)) %>%
  select(stabbr, name, period, realnom, pdtrendiqr) %>%
  group_by(realnom) %>%
  arrange(pdtrendiqr) %>%
  mutate(rank=row_number()) %>%
  select(-pdtrendiqr) %>%
  pivot_wider(names_from = realnom, values_from = rank) 

 p <- pdata %>%
   filter(stabbr != "US") %>%
   ggplot(aes(nominal, real, label=stabbr)) +
   geom_point() +
   geom_text() +
   geom_abline(slope=1, intercept=0) +
   ggtitle("Rank of volatility using nominal and inflation-adjusted data",
           paste0("IQR of percent difference from trend, ", pd))
 p
# 1970-2020:
# 2000-2020: substantial switching of ranks in the ranks 7-35 range, but not at extremes
 
 
 savefig(basename="fig_realnom_states", .p=p, .pdata=pdata,
        width=8, height=8)

```

```{r fig_realnom_taxes, eval=FALSE}
glimpse(volall)
# count(volall, realnom)

vnames <- c("tottax", "iit", "gst", "selsalestax", "cit", "sevtax", "othertax")

pd <- "1970-2020"
pd <- "2000-2020"

pdata <- volall %>%
  filter(stabbr=="US", period==pd, name %in% vnames) %>%
  filter(!is.na(pdtrendiqr)) %>%
  select(stabbr, name, period, realnom, pdtrendiqr) %>%
  group_by(realnom) %>%
  arrange(pdtrendiqr) %>%
  mutate(rank=row_number()) %>%
  select(-pdtrendiqr) %>%
  pivot_wider(names_from = realnom, values_from = rank) 
pdata

#  p <- pdata %>%
#    ggplot(aes(nominal, real, label=name)) +
#    geom_point() +
#    geom_text() +
#    geom_abline(slope=1, intercept=0) +
#    ggtitle("Volatility ranking using nominal and inflation-adjusted data",
#            paste0("IQR of percent difference from trend, ", pd))
# p
 
 savefig(basename="fig_realnom_taxes", .p=p, .pdata=pdata,
        width=8, height=8)

```


## vol selected components have wages become more volatile??
```{r eval=FALSE}
# volatility selected components
# temp <- count(vbase, name)

# create an agi df that can be used by f_vol -- it needs nominal gdp

agi1 <- agitpc %>% 
  mutate(stabbr="US", realnom="nominal") %>%
  bind_rows(vbase %>%
              filter(stabbr=="US", realnom=="nominal", name=="gdp") %>%
              select(year, stabbr, name, realnom, value))

agi2 <- agi1 %>%
  arrange(stabbr, name, realnom, year) %>% 
  group_by(stabbr, name, realnom) %>%
  filter(year %in% 1959:2020) %>% # keep 1959 so we have percent change
  mutate(pch=value / value[match(year - 1, year)] - 1) %>%
  # drop the 1959 values which will have NA for pch
  filter(year %in% 1960:2020) %>%
  mutate(pchtrend=hptrend(pch),
         dpchtrend=pch - pchtrend,
         trend=hptrend(value),
         pdtrend=value / trend - 1) %>%
  ungroup
summary(agi2)

ylist <- list(
  c(1970, 2020),
  c(2000, 2020),
  c(1960, 1969),
  c(1970, 1979),
  c(1980, 1989),
  c(1990, 1999),
  c(2000, 2009),
  c(2010, 2019)
)
# unique(agitpc$name)
# f_vol is defined in prep_vol.r
temp <- map_dfr(ylist, f_vol, vars=unique(agitpc$name), vbase=agi2)

temp %>%
  select(stabbr, name, period, realnom, pdtrendiqr) %>%
  pivot_wider(values_from = pdtrendiqr)
  

```


# BOX: HOW THIS REPORT MEASURES VOLATILITY

```{r fig_ustaxgdp_trend_actual}
pdata <- vbase %>%
  filter(year >= 1990, 
         name=="tottax", 
         realnom=="nominal", 
         stabbr=="US") %>%
  select(stabbr, year, name, value, trend) %>%
  pivot_longer(c(value, trend), names_to = "measure") %>%
  mutate(measuref=factor(measure,
                      levels=c("value", "trend"),
                      labels=c("actual", "trend")))

p <- pdata %>%
  ggplot(aes(year, value / 1e6, colour=measuref)) +
  geom_band(recdata(unique(pdata$year))) +
  geom_line(size=1) +
  geom_point(size=1.15) +
  scale_y_continuous(name="$ billions",
                     breaks=seq(100, 2000, 100),
                     labels=label_comma(accuracy=1)) +
  scale_x_continuous(name=NULL, breaks=seq(1990, 2030, 2)) +
  scale_colour_manual(values=bluegreen) +
  ggtitle("State government tax revenue in the United States",
          subtitle="Actual and trend") +
  labs(caption="Note: Recession periods are shaded.\nSource: U.S. Bureau of the Census") +
  theme_bw() +
  theme(plot.caption = element_text(hjust=0, size=9)) +
  theme(legend.title = element_blank())
p


savefig(basename="fig_ustax_trend_actual")

```

```{r fig_ustax_pdtrend}

pdata <- vbase %>%
  filter(year >= 1990, 
         name=="tottax", 
         realnom=="nominal", 
         stabbr=="US") %>%
  select(stabbr, year, name, pdtrend)

quantile(pdata$pdtrend) # percentiles used in text

# repeat for GDP
vbase %>%
  filter(year >= 1990, 
         name=="gdp", 
         realnom=="nominal", 
         stabbr=="US") %>%
  pull(pdtrend) %>%
  quantile()


p <- pdata %>%
  ggplot(aes(year, pdtrend)) +
  geom_band(recdata(unique(pdata$year))) +
  geom_line(size=1, colour="blue") +
  geom_point(size=1.15, colour="blue") +
  geom_hline(yintercept = 0) +
  scale_y_continuous(name="% deviation from trend",
                     breaks=seq(-1, 1, .01),
                     labels=label_percent(accuracy=1)) +
  scale_x_continuous(name=NULL, breaks=seq(1990, 2030, 2)) +
  ggtitle("State government tax revenue in the United States",
          subtitle="% deviation from trend") +
  labs(caption="Note: Recession periods are shaded.\nSource: U.S. Bureau of the Census") +
  theme_bw() +
  theme(plot.caption = element_text(hjust=0, size=9)) +
  theme(legend.title = element_blank())
p

savefig(basename="fig_ustax_pdtrend")

```

```{r fig_pdtrend_taxgdp_box}

pdata <- vbase %>%
  filter(year >= 1990, 
         name %in% c("tottax", "gdp"), 
         realnom=="nominal", 
         stabbr=="US") %>%
  select(stabbr, year, name, realnom, pdtrend) %>%
  mutate(namef=factor(name,
                      levels=c("tottax", "gdp"),
                      labels=c("Taxes", "GDP")))
summary(pdata)


gtitle <- "Volatility of state tax revenue and gross domestic product (GDP), 1990-2020"
subt <- NULL

note1 <- "Notes: Volatility measure is percentage deviation of revenue from trend."
note2 <- "Width of box is the interquartile range of percentage deviation."
note3 <- "Dots represent extreme observations."
note <- paste0(note1, " ", note2, " ", note3)
note <- str_wrap(note, width=120)

src <- paste0("Sources: ", source_census, ". ", source_bea, ".")
capt <- paste0(note, "\n", src)

p <- pdata %>%
  # left_join(taxnames, by = "name") %>%
  ggplot(aes(x=pdtrend, y=reorder(namef, pdtrend, IQR, na.rm=TRUE))) +
  geom_boxplot(width=0.5, 
               lwd=.1, 
               outlier.size=.75,
               notch=FALSE, 
               fatten=6,
               fill="blue", 
               outlier.colour="blue",
               alpha=.2) +
  geom_vline(xintercept = 0,) +
  labs(x="percentage", y=NULL) +
  scale_x_continuous(breaks=seq(-2, 2, .01), 
                     labels = label_percent(accuracy=1)) + #, 
                     #limits=c(-.38, .62)) +
  # scale_x_break(c(.65, 1.3)) +
  # scale_x_break(c(-.58, -.38)) +
  ggtitle(gtitle,
          subtitle=subt) +
  labs(caption=capt) +
  theme_report
p
savefig(basename="fig_pdtrend_taxgdp_box", height = 5)


```

# 3. HOW DOES VOLATILITY VARY BY TAX?



## Comparison of taxes

```{r}
# data check
# glimpse(stack)
# glimpse(vbase)
# 
# count(vbase, name)
# check <- vbase %>%
#   filter(name %in% c("tottax", "iit", "gst", "selsalestax", "cit", "sevtax", "othertax"),
#          realnom=="nominal",
#          stabbr=="US") %>%
#   select(stabbr, name, year, value) %>%
#   pivot_wider() %>%
#   mutate(checksum=select(., -c(stabbr, year, tottax)) %>% 
#            rowSums(na.rm=TRUE),
#          check=checksum - tottax)
# summary(check)
# 
# # look at tax shares
# check %>%
#   select(-c(checksum, check)) %>%
#   mutate(across(-c(stabbr, year, tottax), ~ .x / tottax),
#          big3=iit + gst + selsalestax) %>%
#   ht
# big3 = 84% of total, less in early years

```

```{r fig_all_pdtrend}

# we want a 2-panel figure with percent differences from trend
#   top panel has major taxes: iit, gst, selsalestax
#   bottom panel has smaller taxes: cit, sevtax, othertax

vtop <- c("iit", "gst", "selsalestax")
vbottom <- c("cit", "sevtax", "othertax")
vnames <- c("tottax", vtop, vbottom)

pdata <- vbase %>%
  filter(name %in% vnames,
         realnom=="nominal",
         stabbr=="US",
         year >= 1960) %>%
  select(year, name, tax_pdtrend=pdtrend) %>%
  # tottax value on each record
  group_by(year) %>%
  mutate(tot_pdtrend=tax_pdtrend[name=="tottax"]) %>%
  ungroup %>%
  filter(name!="tottax") %>% # we don't want tottax anymore because we paired it with each tax
  pivot_longer(contains("pdtrend"), names_to = "type") %>%
  mutate(namef=factor(name, levels=taxnames$name, labels=taxnames$namef),
         panel=ifelse(name %in% vtop, "top", "bottom"),
         typef=factor(type, 
                      levels=c("tax_pdtrend", "tot_pdtrend"),
                      labels=c("Comparison tax", "Total taxes"))) %>%
  arrange(panel, namef, typef, year)


years <- min(pdata$year):max(pdata$year)
recs <- recdata(years)
lsize <- .75
psize <- .75

ptop <- pdata %>%
  filter(panel=="top") %>%
  ggplot(aes(year, value, colour=typef)) +
  # put recession bands down before lines and dots
  geom_band(recs) +
  geom_line(size=lsize) +
  geom_point(size=psize) +
  geom_hline(yintercept = 0) +
  scale_x_continuous(name=NULL, breaks=seq(1950, 2030, 5)) +
  scale_y_continuous(breaks=seq(-1, 1, .05),
                     limits=c(-.35, .35),
                     labels=label_percent(accuracy=1)) +
  # scale_colour_brewer(type="qual", palette="Set1") +
  # scale_color_viridis(discrete=TRUE) +
  scale_color_manual(values=bluegreen) +
  ggtitle("Volatility of major taxes",
          subtitle="Percentage deviation from trend") +
  labs(x=NULL, y="% deviation from trend",
       caption=NULL) +
  theme_report +
  legend_notitle +
  caption_left +
  facet_wrap(~namef, ncol=3, scales="fixed")
ptop

pbottom <- pdata %>%
  filter(panel=="bottom") %>%
  ggplot(aes(year, value, colour=typef)) +
  # put recession bands down before lines and dots
  geom_band(recs) +
  geom_line(size=lsize) +
  geom_point(size=psize) +
  geom_hline(yintercept = 0) +
  scale_x_continuous(name=NULL, breaks=seq(1950, 2030, 5)) +
  scale_y_continuous(breaks=seq(-1, 1, .05),
                     labels=label_percent(accuracy=1)) +
  # scale_colour_brewer(type="qual", palette="Set1") +
  # scale_color_viridis(discrete=TRUE) +
  scale_color_manual(values=bluegreen) +
  ggtitle("Volatility of smaller taxes",
          subtitle="Percentage deviation from trend") +
  labs(x=NULL, y="% deviation from trend",
       caption=NULL) +
  theme_report +
  legend_notitle +
  caption_left +
  facet_wrap(~namef, ncol=3, scales="fixed")
pbottom

p <- ptop / pbottom
p
savefig("fig_all_pdtrend", .p=p, .pdata=pdata, width=10, height=6, scale=1.5) 

```


```{r fig_pdtrend_taxtype_box}

pdata <- vbase %>%
  filter(year %in% 2000:2020, 
         realnom=="nominal", 
         name %in% taxnames$name,
         stabbr != "US")
count(pdata, name)


gtitle <- "State tax revenue volatility by tax type, 2000-2020"
subt <- "Taxes ranked from most volatile to least, based on width of box"

capt1 <- "Notes: Volatility measure is percentage deviation of revenue from trend."
capt2 <- "Width of box is the interquartile range of % deviation."
capt3 <- "Dots represent extreme observations."
capt4 <- "Data are for all 50 states, pooled."
capt <- paste0(capt1, " ", capt2, " ", capt3, " ", capt4)
capt <- str_wrap(capt, width=120)

p <- pdata %>%
  left_join(taxnames, by = "name") %>%
  ggplot(aes(x=pdtrend, y=reorder(namef, pdtrend, IQR, na.rm=TRUE))) +
  geom_boxplot(width=0.5, 
               lwd=.1, 
               outlier.size=.75,
               notch=FALSE, 
               fatten=6,
               fill="blue", 
               outlier.colour="blue",
               alpha=.2) +
  geom_vline(xintercept = 0,) +
  labs(x="percentage", y=NULL) +
  scale_x_continuous(breaks=seq(-2, 2, .1), 
                     labels = label_percent(accuracy=1), 
                     limits=c(-.38, .62)) +
  # scale_x_break(c(.65, 1.3)) +
  # scale_x_break(c(-.58, -.38)) +
  ggtitle(gtitle,
          subtitle=subt) +
  labs(caption = capt) +
  theme_report
p
savefig(basename="fig_pdtrend_taxtype_box")
```


## Personal income tax

```{r fig_pi_agi}
count(vbase, name)

vars <- c("pi", "agi")
labs <- c("Personal income", "Adjusted gross income")

pdata <- vbase %>%
  filter(stabbr=="US", name %in% c("pi", "agi"), realnom=="nominal") %>%
  select(stabbr, name, year, pdtrend) %>%
  mutate(namef=factor(name, levels=vars, labels=labs))

years <- min(pdata$year):max(pdata$year)
recs <- recdata(years)
lsize <- .75
psize <- .75

capt <- paste0("Sources: ", source_bea, " and ", source_soi, ".")

p <- pdata %>%
  ggplot(aes(year, pdtrend, colour=namef)) +
  # put recession bands down before lines and dots
  geom_band(recs) +
  geom_line(size=lsize) +
  geom_point(size=psize) +
  geom_hline(yintercept = 0) +
  scale_x_continuous(name=NULL, breaks=seq(1950, 2030, 5)) +
  scale_y_continuous(breaks=seq(-1, 1, .05),
                     labels=label_percent(accuracy=1)) +
  scale_colour_manual(values=bluegreen) +
  ggtitle("Volatility of personal income and federal adjusted gross income",
          subtitle="% deviation from trend")  +
  labs(x=NULL, 
       y="% of own trend",
       caption=capt) +
  theme_report +
  legend_notitle +
  caption_left
p

savefig("fig_pi_agi")

```

```{r fig_iit_sources_2panel}

agivars <- c("agi", 
             "wages", 
             "busincnet", 
             "netcgll", 
             "other")
agilabs <- c("Adjusted gross income", "Wages",
             "Business income",
             "Capital gains",
             "Other")

pdata <- agitpc %>%
  # calculate other
  pivot_wider() %>%
  mutate(other=agi - wages - netcgll - busincnet) %>%
  pivot_longer(-year) %>%
  group_by(name) %>%
  mutate(trend=hptrend(value, smooth=6.25),
         dtrend=value - trend,
         pdtrend=value / trend - 1) %>%
  group_by(year) %>%
  mutate(dtrendvsagi=dtrend / trend[name=="agi"],
         namef=factor(name, 
                      levels=agivars,
                      labels=agilabs)) %>%
  ungroup %>%
  arrange(year, namef)

capt1 <- "Source: IRS Statistics of Income via https://www.taxpolicycenter.org"
note1 <- "Notes: Capital gains are net capital gains less losses. Business income is net of losses."
capt <- paste0(capt1, "\n", note1)

recs <- recdata(unique(pdata$year))
lsize <- .75
psize <- .75

p1 <- pdata %>%
  filter(name != "other") %>%
  ggplot(aes(year, pdtrend, colour=namef)) +
  # put recession bands down before lines and dots
  geom_band(recs) +
  geom_line(size=lsize) +
  geom_point(size=psize) +
  geom_hline(yintercept = 0) +
  scale_x_continuous(name=NULL, breaks=seq(1950, 2030, 5)) +
  scale_y_continuous(breaks=seq(-1, 1, .05),
                     labels=label_percent(accuracy=1)) +
  scale_colour_brewer(type="qual", palette="Set1") +
  ggtitle("Volatility of selected components of federal adjusted gross income",
          subtitle="Percentage deviation from own trend")  +
  labs(x=NULL, 
       y="% of own trend",
       caption=NULL) +
  theme_report +
  legend_notitle +
  caption_left
p1


p2 <- pdata %>%
  filter(name != "other") %>%
  ggplot(aes(year, dtrendvsagi, colour=namef)) +
  # put recession bands down before lines and dots
  geom_band(recs) +
  geom_line(size=lsize) +
  geom_point(size=psize) +
  geom_hline(yintercept = 0) +
  scale_x_continuous(name=NULL, breaks=seq(1950, 2030, 5)) +
  scale_y_continuous(breaks=seq(-1, 1, .025),
                     labels=label_percent(accuracy=.1)) +
  scale_colour_brewer(type="qual", palette="Set1") +
  ggtitle("Volatility of selected components of federal adjusted gross income",
          subtitle="Deviation from own trend as % of AGI trend") +
  labs(x=NULL, 
       y="% of AGI trend",
       caption=capt) +
  theme_report +
  legend_notitle +
  caption_left
p2

p <- p1 / p2
p
savefig("fig_iit_sources_2panel", width=8, height=8)


# capital gains as % of AGI, mentioned in the text
pdata %>%
  filter(name %in% c("agi", "netcgll")) %>%
  select(year, name, value) %>%
  pivot_wider() %>%
  mutate(cgpct=netcgll / agi) %>%
  summarise(mcgpct=median(cgpct, na.rm=TRUE),
            mcgpct2000p=median(cgpct[year >= 2000], na.rm = TRUE)) 

```

```{r}

# check business income volatility
agitpc
count(agitpc, name)



```



```{r tab_agi2009}

agivars <- c("agi", 
             "wages", 
             "busincnet", 
             "netcgll", 
             "other")
agilabs <- c("Adjusted gross income", "Wages",
             "Business income",
             "Capital gains",
             "Other")

pdata <- agitpc %>%
  # calculate other
  pivot_wider() %>%
  mutate(other=agi - wages - netcgll - busincnet) %>%
  pivot_longer(-year) %>%
  group_by(name) %>%
  mutate(trend=hptrend(value, smooth=6.25),
         dtrend=value - trend,
         pdtrend=value / trend - 1) %>%
  group_by(year) %>%
  mutate(dtrendvsagi=dtrend / trend[name=="agi"],
         namef=factor(name, 
                      levels=agivars,
                      labels=agilabs)) %>%
  ungroup %>%
  arrange(year, namef)

tabdata <- pdata %>%
  filter(year==2009) %>%
  select(name, namef, value, trend, dtrend, pdtrend, dtrendvsagi) %>%
  mutate(trendshare=trend / trend[name=="agi"],
         volshare=dtrend / dtrend[name=="agi"])
tabdata

tab <- tabdata %>%
  gt() %>%
  cols_hide(name) %>%
  tab_header(
    title = "Adjusted gross income in 2009",
    subtitle = NULL
    ) %>%
  cols_label(namef="Income component",
             value="Actual",
             trend="Trend",
             dtrend=html("Deviation from trend"),
             pdtrend=html("own trend"),
             dtrendvsagi=html("AGI trend"),
             trendshare=html("Trend as %<br>of AGI trend"),
             volshare=html("Deviation as %<br>of AGI deviation")) %>%
  tab_spanner(
        label = "Amount in $ billions",
        columns = c(value, trend, dtrend)
        ) %>%
  tab_spanner(
        label = "Deviation from own trend as % of:",
        columns = c(pdtrend, dtrendvsagi)
        ) %>%
  cols_align(
    align = c("left"),
    columns = namef) %>%
  fmt_number(
    columns=c(value, trend, dtrend),
    scale_by = 1e-3,
    decimals=0
  ) %>%
  fmt_currency(
    rows=1,
    columns=c(value, trend, dtrend),
    scale_by = 1e-3,
    decimals=0
  ) %>%
  fmt_percent(
    columns = c(pdtrend, dtrendvsagi, trendshare, volshare),
    decimals = 1) %>%
  tab_style(
    style = list(
      cell_fill(color = "grey95")
      ),
    locations = cells_body(
      rows=is.even(1:nrow(tabdata))
      )
    )
tab

savetab("tab_agi2009")

```

```{r fig_capgains_agi}

# get capgains as share of agi -- both datasets already in memory
# for this we use capgains from my capgains spreadsheet, 
# and agi directly from the IRS
# this ends in 2019 but that's ok because we don't have good data for
# capital gains in 2020 yet

pdata <- agi %>%
  select(-src) %>%
  left_join(capgains, by = "year") %>%
  mutate(cgagi=capgains / agi)

years <- min(pdata$year):max(pdata$year)
recs <- recdata(years)

p <- pdata %>%
  na.omit() %>%
  ggplot(aes(year, cgagi)) +
  # put recession bands down first
  geom_band(recs) +
  geom_line(size=1, colour="blue") +
  geom_point(size=1, colour="blue") +
  scale_x_continuous(name=NULL, breaks=seq(1950, 2020, 5)) +
  scale_y_continuous(name="% of AGI",
                     breaks=seq(-.20, .20, .02),
                     labels=label_percent(accuracy=1),
                     limits=c(0, NA)) +
  ggtitle("Realized capital gains as a percentage of adjusted gross income") +
  labs(caption=paste0("Source: ", source_soi)) +
  theme_report +
  annotate(geom="text", x=1986.5, y=pdata$cgagi[pdata$year==1986],
           hjust=0,
           colour="darkgreen",
           size=2,
           label="Acceleration before 1986\ntax reform took effect")
p

savefig("fig_capgains_agi")

```

## General sales tax

Nothing here now - I moved it all to deadwood.
```{r fig_gstpce_components}
gstpce <- readRDS(here::here("data", "gstpce.rds"))
gstvol <- readRDS(here::here("data", "gstvol.rds"))

count(gstpce, line, name, vdesc)

pcevars <- c("gst", 
            "DDURRC", 
            "DNDGRC", 
            "DSERRC")
pcelabs <- c("General sales tax",
             "Durable goods",
             "Nondurable goods",
             "Services")
cbind(pcevars, pcelabs)

pdata <- gstpce %>%
  filter(name %in% pcevars, year %in% 1960:2020) %>%
  mutate(namef=factor(name, levels=pcevars, labels=pcelabs)) %>%
  arrange(year, namef)

capt <- paste0("Sources: ", source_census, " and ", source_bea)

recs <- recdata(unique(pdata$year))
lsize <- .75
psize <- .75

p <- pdata %>%
  ggplot(aes(year, pdtrend, colour=namef)) +
  # put recession bands down before lines and dots
  geom_band(recs) +
  geom_line(size=lsize) +
  geom_point(size=psize) +
  geom_hline(yintercept = 0) +
  scale_x_continuous(name=NULL, breaks=seq(1960, 2030, 5)) +
  scale_y_continuous(breaks=seq(-1, 1, .01),
                     labels=label_percent(accuracy=1)) +
  scale_colour_brewer(type="qual", palette="Set1") +
  ggtitle("Volatility of general sales tax and major consumption categories",
          subtitle="Percentage deviation from trend")  +
  labs(x=NULL, 
       y="% of trend",
       caption=capt) +
  theme_report +
  legend_notitle +
  caption_left
p

# savefig(basename, .p=p, .pdata=pdata, width=10, height=6, scale=1)
savefig(basename="fig_gstpce_components", .p=p, .pdata=pdata, width=10, height=6, scale=1)

```


```{r tab_gstpce_pdtrendiqr, eval=TRUE}
gstvol
gstvol |> select(name, line, vdesc)

# get each consumption component's share of consumption
pceshares <- gstvol %>%
  filter(!name %in% c("gst", "gdp")) |> 
  select(stabbr, line, name, vdesc, data) %>%
  # we want to keep data from one set
  unnest(data) |> 
  filter(year==2020) |> 
  select(stabbr, line, name, vdesc, value) |> 
  mutate(pceshare2020=value / value[name=="DPCERC"]) |> 
  arrange(desc(pceshare2020))

lines <- c(1:4, 8, 9, 13, 14)
gstvol |> filter(line %in% lines) |> select(name, line, vdesc)
pceshares |> filter(line %in% lines) |> arrange(line)
pceshares

pceshares |> 
  filter(!line %in% c(25, 27, 28, 23, 24, 22))

capt <- paste0("Sources: ", source_census, " and ", source_bea)

lines <- c(1, 3, 4, 8, 9, 13, 14)

tabdata <- gstvol |> 
  filter(line %in% lines | name=="gst") |> 
  left_join(pceshares |> select(name, pceshare2020), by = "name") |> 
  mutate(namef=str_extract_before_first(vdesc, ","),
         namef=ifelse(name=="DPCERC", paste0(namef, " (total)"), namef),
         namef=ifelse(name=="gst", "General sales tax", namef)) |> 
  select(name, namef, pdtrendiqr, pceshare2020) |> 
  arrange(desc(pdtrendiqr))
tabdata

tab <- tabdata %>%
  gt() %>%
  cols_hide(name) %>%
  tab_header(
    title = "Volatility of selected major components of consumption, 1970-2020"
    ) %>%
  cols_label(namef="Consumption component",
             pdtrendiqr="Volatility",
             pceshare2020=html("Component<br>as % of<br>consumption")) %>%
  cols_align(
    align = c("left"),
    columns = namef) %>%
  # fmt_number(
  #   columns=c(pdtrendiqr, pceshare2020),
  #   decimals=1
  # ) %>%
  fmt_percent(
    columns = c(pdtrendiqr, pceshare2020),
    # rows=1,
    decimals = 1) %>%
  fmt_missing(columns = pceshare2020) |> 
  tab_style(
    style = list(
      cell_fill(color = "grey95")
      ),
    locations = cells_body(
      rows=is.even(1:nrow(tabdata))
      )
    ) %>%
  tab_footnote(
    footnote = "Interquartile range of percentage deviation from trend.",
    locations = cells_column_labels(columns = pdtrendiqr)
    ) %>%
  tab_footnote(
    footnote = "Consumption components are not mutually exclusive; percentage shares sum to more than 100%.",
    locations = cells_column_labels(columns = pceshare2020)
    ) %>%
  tab_source_note(capt)
tab

savetab("tab_gstpce_pdtrendiqr")

xlines <- c(25, 27, 28, 23, 24, 22)

tabdata2 <- gstvol |> 
  filter((!line %in% xlines) | (name=="gst")) |> 
  filter(name!="gdp") |> 
  left_join(pceshares |> select(name, pceshare2020), by = "name") |> 
  mutate(namef=str_extract_before_first(vdesc, ","),
         namef=ifelse(name=="DPCERC", paste0(namef, " (total)"), namef),
         namef=ifelse(name=="gst", "General sales tax", namef)) |> 
  select(name, namef, pdtrendiqr, pceshare2020) |> 
  arrange(desc(pdtrendiqr))
tabdata2

tab2 <- tabdata2 %>%
  gt() %>%
  cols_hide(name) %>%
  tab_header(
    title = "Volatility of selected major components of consumption, 1970-2020"
    ) %>%
  cols_label(namef="Consumption component",
             pdtrendiqr="Volatility",
             pceshare2020=html("Component<br>as % of<br>consumption")) %>%
  cols_align(
    align = c("left"),
    columns = namef) %>%
  fmt_percent(
    columns = c(pdtrendiqr, pceshare2020),
    # rows=1,
    decimals = 1) %>%
  fmt_missing(columns = pceshare2020) |> 
  tab_style(
    style = list(
      cell_fill(color = "grey95")
      ),
    locations = cells_body(
      rows=is.even(1:nrow(tabdata2))
      )
    ) %>%
  tab_footnote(
    footnote = "Interquartile range of percentage deviation from trend.",
    locations = cells_column_labels(columns = pdtrendiqr)
    ) %>%
  tab_footnote(
    footnote = "Consumption components are not mutually exclusive; percentage shares sum to more than 100%.",
    locations = cells_column_labels(columns = pceshare2020)
    ) %>%
  tab_source_note(capt)
tab2

savetab("tab_gstpce_pdtrendiqr2", .tab=tab2)



```


# 4. HOW HAS VOLATILITY CHANGED OVER TIME?


```{r map_decades_pdtrendiqr}
count(volall, period)

voldecades <- volall %>%
  filter(period %in% decades)
# count(voldecades, period)

# volfull <- volall %>%
#   filter(period=="1970-2020")

gtitle <- "Tax revenue volatility by decade"

# f_volmap is in functions_maps.r
# CAUTION: adjust width and height to avoid white space around plot / map
mlist <- f_volmap(tax="tottax", measure="pdtrendiqr", 
                  gtitle=gtitle, data=voldecades, facetvar="period")
savefig(basename="map_decades_pdtrendiqr", .p=mlist$m, .pdata = mlist$mbase,
        width=8, height=6)

```

```{r fig_pdtrend_taxtype_decades_box}
count(volall, period)

pdata <- volall %>%
  filter(realnom=="nominal", 
         !period %in% c("1960-1969", "1970-2020"),
         name %in% taxnames$name,
         stabbr != "US") %>%
  select(stabbr, name, namef, period, data) %>%
  unnest(data)

gtitle1 <- "State tax revenue percent deviation from trend by tax type,"
gtitle2 <- " 50 states pooled, ranked by IQR of % deviation"
gtitle <- paste0(gtitle1, gtitle2)

p <- pdata %>%
  ggplot(aes(x=pdtrend, y=reorder(namef, pdtrend, IQR, na.rm=TRUE))) +
  geom_boxplot(width=0.5, 
               lwd=.1, 
               outlier.size=.75,
               notch=FALSE, 
               fatten=6,
               fill="blue", 
               outlier.colour="blue",
               alpha=.2) +
  geom_vline(xintercept = 0,) +
  labs(x="percentage", y=NULL) +
  scale_x_continuous(breaks=seq(-2, 2, .1), 
                     labels = label_percent(accuracy=1), 
                     limits=c(-.38, .62)) +
  # scale_x_break(c(.65, 1.3)) +
  # scale_x_break(c(-.58, -.38)) +
  ggtitle(gtitle,
          subtitle="Five decades") +
  theme_report +
  facet_wrap(~period, ncol=1)
p
savefig(basename="fig_pdtrend_taxtype_decades_box", width=6, height=8, scale=1.25)

```

```{r fig_pdtrend_decades_taxtype_box}

pdata <- volall %>%
  filter(realnom=="nominal", 
         !period %in% c("1960-1969", "1970-2020"),
         name %in% taxnames$name,
         stabbr != "US") %>%
  select(stabbr, name, namef, period, data) %>%
  unnest(data)

gtitle <- "State tax revenue year percent deviation from trend by tax type over 5 decades"
gsubtitle <- "50 states pooled, box widths indicate interquartile range of % deviation from trend"
p <- pdata %>%
  # mutate(period=factor(period, levels=unique(pdata$period))) %>%
  ggplot(aes(x=pdtrend, y=reorder(period, desc(period)))) +
  geom_boxplot(width=0.5, 
               lwd=.1, 
               outlier.size=.75,
               notch=FALSE, 
               fatten=6,
               fill="blue", 
               outlier.colour="blue",
               alpha=.2) +
  geom_vline(xintercept = 0,) +
  labs(x="percentage", y=NULL) +
  scale_x_continuous(breaks=seq(-2, 2, .1), 
                     labels = label_percent(accuracy=1), 
                     limits=c(-.38, .62)) +
  # scale_x_break(c(.65, 1.3)) +
  # scale_x_break(c(-.58, -.38)) +
  ggtitle(gtitle,
          subtitle=gsubtitle) +
  theme_report +
  facet_wrap(~namef, ncol=1)
p
savefig(basename="fig_pdtrend_decades_taxtype_box", width=6, height=8, scale=1.25)

```

```{r tab_rec_features}
rec_features

# bring in tax revenue change as a recession feature ---
rec_taxdetail <- vbase %>%
  filter(stabbr!="US", realnom=="real", name %in% c("tottax", "iit", "gst")) %>%
  select(stabbr, name, year, value) %>%
  arrange(stabbr, name, year) %>%
  group_by(stabbr, name) %>%
  mutate(taxpre = slide_dbl(value, ~max(.x, na.rm=TRUE), .before=2, .after=1),
         taxpost = slide_dbl(value, ~min(.x, na.rm=TRUE), .before=0, .after=4),
         taxchange=taxpost / taxpre - 1)

# get the median tax change for each recession, across states, for each tax
rec_taxmdn <- rec_taxdetail %>%
  filter(year %in% rec_features$recyear) %>%
  select(stabbr, name, recyear=year, taxchange) %>%
  group_by(name, recyear) %>%
  summarise(taxchange=median(taxchange, na.rm=TRUE), .groups="drop") %>%
  pivot_wider(values_from = taxchange) %>%
  filter(recyear != 2020) %>%
  select(recyear, tottax, iit, gst)

# enhance rec_features with tax change
rec_features2 <- rec_features %>%
  left_join(rec_taxmdn, by="recyear")


tab <- rec_features2 %>%
  select(-gst) %>%
  gt() %>%
  tab_header(
    title = "Selected characteristics of the last 8 recessions"
    ) %>%
  cols_label(recyear=html("Initial year of<br>the recession"),
             duration=html("Duration<br>(months)"),
             rgdp=html("Real GDP"),             
             rpce=html("Real personal<br>consumption"),
             urchange=html("Unemployment rate<br>% point change"),
             cgpch=html("% change in<br>national<br>capital gains"),
             tottax=html("Total taxes"),
             iit=html("Individual<br>income tax")) %>%
  tab_spanner(
    label = "% change, recession peak to trough:",
    columns = c(rgdp, rpce)
    ) %>%
  fmt_percent(
    columns = c(rgdp, rpce, urchange, cgpch, tottax, iit),
    decimals = 1) %>%
  fmt_number(
    columns = c(duration),
    decimals = 0) %>%
  fmt_missing(columns=c(tottax, iit)) %>%
  tab_footnote(
    footnote = "Highest quarterly value within 1 year of start minus lowest value within 2 years of trough.",
    locations = cells_column_labels(columns = urchange)
    ) %>%
  tab_footnote(
    footnote = "% change from highest annual value within two years of start to lowest value in 2 years after start.",
    locations = cells_column_labels(columns = cgpch)
    ) %>%
  # tab_footnote(
  #   footnote = "Extensions of tax-payment dates made the decline appear worse than it was.",
  #   locations = cells_body(columns = taxchange, rows=recyear==2020)
  #   ) %>%
  tab_style(
    style = list(
      cell_fill(color = "grey95")
      ),
    locations = cells_body(
      rows=is.even(1:nrow(rec_features2))
      )
    )
tab

savetab("tab_rec_features", .tabdata=rec_features)

```

```{r map_recessions_pdtrendiqr}
glimpse(volrecs)
count(volrecs, recyear, period)  

gtitle <- "Tax revenue volatility: 5 years before recession start though 5 years after"

mlist <- f_volmap(tax="tottax", measure="pdtrendiqr", 
                  gtitle=gtitle, data=volrecs, facetvar="recyear")
savefig(basename="map_recessions_pdtrendiqr", .p=mlist$m, .pdata = mlist$mbase,
        width=8, height=6)

# mlist <- f_volmap(tax="tottax", measure="pchiqr", 
#                   gtitle=gtitle, data=volrecs, facetvar="recyear")
# savefig(basename="map_recessions_pchiqr", .p=mlist$m, .pdata = mlist$mbase,
#         width=8, height=6)

# mlist <- f_volmap(tax="tottax", measure="dpchtrendiqr", 
#                   gtitle=gtitle, data=volrecs, facetvar="recyear")
# savefig(basename="map_recessions_dpchtrendiqr", .p=mlist$m, .pdata = mlist$mbase)
# 
# mlist <- f_volmap(tax="tottax", measure="sre", 
#                   gtitle=gtitle, data=volrecs, facetvar="recyear")
# savefig(basename="map_recessions_sre", .p=mlist$m, .pdata = mlist$mbase)

```

```{r fig_pdtrend_recessions_taxtype_box}

pdata <- volrecs %>%
  filter(realnom=="nominal", 
         # !period %in% c("1960-1969", "1970-2020"),
         name %in% taxnames$name,
         stabbr != "US") %>%
  select(stabbr, name, namef, recyear, data) %>%
  unnest(data)
count(pdata, recyear)

gtitle <- "State tax revenue percent deviation from trend by tax type across 6 recessions"
gsubtitle <- "50 states pooled, box widths indicate interquartile range of % deviation"
p <- pdata %>%
  # mutate(period=factor(period, levels=unique(pdata$period))) %>%
  ggplot(aes(x=pdtrend, y=reorder(recyear, desc(recyear)))) +
  geom_boxplot(width=0.5, 
               lwd=.1, 
               outlier.size=.75,
               notch=FALSE, 
               fatten=6,
               fill="blue", 
               outlier.colour="blue",
               alpha=.2) +
  geom_vline(xintercept = 0,) +
  labs(x="percentage", y=NULL) +
  scale_x_continuous(breaks=seq(-2, 2, .1), 
                     labels = label_percent(accuracy=1), 
                     limits=c(-.38, .62)) +
  # scale_x_break(c(.65, 1.3)) +
  # scale_x_break(c(-.58, -.38)) +
  ggtitle(gtitle,
          subtitle=gsubtitle) +
  theme_report +
  facet_wrap(~namef, ncol=1)
p
savefig(basename="fig_pdtrend_recessions_taxtype_box", width=6, height=8, scale=1.25)

```

```{r tab_recession_nonrecession}

recyears <- recessions %>% 
  select(year=rec_year, trough) %>%
  filter(year >= 1960) %>%
  group_by(year) %>%
  summarise(year=(year - 1):(year(trough) + 1), .groups="drop") %>%
  mutate(recession=TRUE) %>%
  distinct
  

recdata <- vbase %>%
  filter(stabbr!="US",
         realnom=="nominal",
         name %in% taxnames$name) %>%
  select(stabbr, name, realnom, year, pdtrend) %>%
  left_join(recyears, by = "year") %>%
  mutate(recession=ifelse(is.na(recession), FALSE, recession),
         namef=factor(name, levels=taxnames$name, labels=taxnames$namef))
recdata
count(recdata, name, namef)

tabdata <- recdata %>%
  group_by(name, namef, recession) %>%
  summarise(pdtrendiqr=IQR(pdtrend, na.rm=TRUE), .groups="drop") %>%
  mutate(recession=ifelse(recession, "recession", "notrec")) %>%
  pivot_wider(names_from = recession, values_from = pdtrendiqr) %>%
  mutate(diff=recession - notrec,
         ratio=recession / notrec) %>%
  arrange(namef)
tabdata

tab <- tabdata %>%
  select(-name) %>%
  gt() %>%
  tab_header(
    title = "Tax revenue volatility in recessionary and non-recessionary periods",
    subtitle="1960 through 2020"
    ) %>%
  cols_label(namef="",
             notrec=html("Non-recessionary"),
             recession=html("Recessionary"),             
             diff=html("Recessionary minus<br>non-recession"),
             ratio=html("Ratio of recessionary<br>to non-recessionary")) %>%
  cols_align(align="left", columns=namef) %>%
  tab_spanner(
    label = "Volatility: Interquartile range of % deviation from trend",
    columns = c(notrec, recession)
    ) %>%
  fmt_percent(
    columns = c(notrec, recession, diff),
    decimals = 1) %>%
  fmt_number(
    columns = c(ratio),
    decimals = 2) %>%
  tab_style(
    style = list(
      cell_fill(color = "grey95")
      ),
    locations = cells_body(
      rows=is.even(1:nrow(tabdata))
      )
    ) %>%
  tab_footnote("Recessionary periods defined as the year before a recession starts through the year after the trough, to allow for a lag between economic activity and revenue.",
               locations=cells_title(groups="title"))
tab

savetab("tab_recession_nonrecession", .tabdata=tabdata)

recdata %>%
  select(year, recession) %>%
  distinct() %>%
  count(recession)


```

# 5. HOW DO PORTFOLIOS OF TAXES AFFECT TOTAL REVENUE VOLATILITY?

```{r function_eff}

eff <- function(vol, growth){
  # function to determine if points are on the efficient frontier
  # vol and growth are vectors of the same length, ordered by vol, then growth
  df <- tibble(vol, growth) %>%
    mutate(eff=ifelse(row_number()==1, TRUE, FALSE))
  eff <- logical(length=length(vol))
  for(i in 1:length(eff)){
    if(i==1) {
      eff[i] <- TRUE
      bestgrowth <- growth[i]
    } else if(growth[i] >= bestgrowth) {
      eff[i] <- TRUE
      bestgrowth <- growth[i]
      }
  }
  eff
}
```

```{r fig_eff_taxes_us}

keep <- c("C105", "T40", "T09", "T41", "T13", "T19", "T24", "T12", "T01", "T16", "T28", "T15")
pdata1 <- sgtax.a %>%
  filter(year >= 1999, item %in% keep, stabbr=="US") %>%
  mutate(name=str_extract_before_first(desc, "(") %>%
           str_trim(),
         name=str_to_sentence(name)) %>%
  select(stabbr, item, name, year, value) %>%
  arrange(stabbr, name, year) %>%
  group_by(stabbr, name) %>%
  mutate(pch=pchya(value, year)) %>%
  filter(year >= 2000) %>%
  group_by(item, name) %>%
  summarise(n=n(),
            growthmdn=median(pch, na.rm=TRUE),
            pchiqr=IQR(pch, na.rm=TRUE),
            .groups="drop")

# clean up the names and add "nudges" for text labels
pdata1
replace <- read_csv(
"item, repname
T09, General sales tax
T19, Other selective sales taxes
T24, Motor vehicle licenses
T28, Occupational & business license taxes
T41, Corporate net income tax
")

pdata <- pdata1 %>%
  left_join(replace, by = "item") %>%
  mutate(name=ifelse(!is.na(repname), repname, name),
         xnudge=case_when(item=="T40" ~ .0021,
                          item=="T12" ~ .0036,
                          item=="T09" ~ -.0039,
                          TRUE ~ 0),
         ynudge=0)
# pdata

p <- pdata %>%
  arrange(pchiqr, growthmdn) %>%
  mutate(eff=eff(pchiqr, growthmdn)) %>%
  ggplot(aes(pchiqr, growthmdn)) +
  # put the line down before points and text
  geom_line(color="blue", data=. %>% filter(eff)) +
  geom_point(size=.75) +
  geom_text_repel(
    # add defult nudges for all
    nudge_y=-.0025,
    aes(x=pchiqr + xnudge, 
        y=growthmdn + ynudge,
        label=str_wrap(name, 12)), 
    size=2) +
  labs(x="Volatility (interquartile range of % change)",
       y="Growth (median growth rate across years)",
       title="Growth and volatility of selected state tax revenue sources",
       subtitle="2000-2020, United States totals") +
  theme_report +
  scale_x_continuous(labels=label_percent(accuracy=.1), breaks=seq(0, 1, .025), limits=c(0, NA)) +
  scale_y_continuous(labels=label_percent(accuracy=1), breaks=seq(0, 1, .01), limits=c(0, NA))
p
savefig("fig_eff_taxes_us", .p=p, .pdata=pdata, width=8, height=6, scale=1)

```

```{r fig_eff_states}

pdata <- vbase %>%
  filter(year %in% 2000:2020, name=="tottax", realnom=="nominal") %>%
  # filter(year %in% 1995:2009, name=="tottax", realnom=="nominal") %>%
  group_by(stabbr) %>%
  summarise(growthmdn=median(pch, na.rm=TRUE),
            pchiqr=IQR(pch, na.rm=TRUE), .groups="drop")

show <- c("US", "AK", "DE", "FL", "KY", "LA", "MI", "NM", "OK", "WV", "WY")
p <- pdata %>%
  filter(stabbr!="AK") %>%
  arrange(pchiqr, growthmdn) %>%
  mutate(eff=eff(pchiqr, growthmdn)) %>%
  mutate(xnudge=case_when(stabbr=="LA" ~ +.0025,
                          stabbr=="MI" ~ -.0025,
                          stabbr=="ID" ~ -.0025,
                          stabbr=="MA" ~ -.0025,
                          TRUE ~ 0),
         ynudge=case_when(stabbr=="LA" ~ +.0025,
                          stabbr=="ID" ~ +.0025,
                          stabbr=="MA" ~ +.0025,
                          TRUE ~ 0)) %>%
  ggplot(aes(pchiqr, growthmdn)) +
  geom_point(size=0.75) +
  geom_text(
    nudge_y=-.0015,
    aes(x=pchiqr + xnudge, 
        y=growthmdn + ynudge,
        label=stabbr), 
    size=2.25, colour="blue",
    # nudge_x=-.001, nudge_y=.001,
    # position=position_dodge(width=.01),
    data=. %>% filter(eff | stabbr %in% show))  +
  # geom_text(aes(label=stabbr))  +
  geom_hline(aes(yintercept = median(growthmdn))) +
  geom_vline(aes(xintercept = median(pchiqr))) +
  scale_x_continuous(labels=label_percent(accuracy=1), breaks=seq(0, 1, .02), limits=c(0, NA)) +
  scale_y_continuous(labels=label_percent(accuracy=1), breaks=seq(0, 1, .02), limits=c(0, NA)) +
  geom_line(color="blue", data=. %>% filter(eff)) +
  labs(x="Volatility (interquartile range of % change)",
       y="Growth (median growth rate across years)",
       title="Growth and volatility of tax revenue across states",
       subtitle="2000-2020") +
  theme_report
p

savefig("fig_eff_states", .p=p, .pdata=pdata, width=8, height=6, scale=1)

```


# 6. HOW DOES VOLATILITY VARY ACROSS STATES?

```{r fig_pdtrend_box}

pdata <- vbase %>%
  filter(year %in% 2000:2020, realnom=="nominal", name=="tottax") 

truncate <- .3

# p <- pdata %>%
#   mutate(stname=stname(stabbr)) %>%
#   ggplot(aes(x=pdtrend, y=reorder(stname, pdtrend, IQR, na.rm=TRUE))) +
#   geom_boxplot(width=0.5, 
#                lwd=.2, 
#                outlier.size=.75,
#                notch=FALSE, 
#                fill="blue", 
#                outlier.colour="blue",
#                alpha=.2) +
#   geom_vline(xintercept = 0) +
#   labs(x="percentage", y=NULL) +
#   scale_x_continuous(breaks=seq(-2, 2, .1),
#                      labels = label_percent(accuracy=1)#,
#                      #limits=c(-truncate, truncate)
#                      ) +
#   # scale_x_break(c(.65, 1.3)) +
#   # scale_x_break(c(-.58, -.38)) +
#   ggtitle("State tax revenue percent deviation from trend, 2000-2020",
#           subtitle="Ranked by interquartile range of deviation") +
#   labs(caption=glue("Note: horizontal axis truncated at +/- {percent(truncate, accuracy=1)}.")) +
#   theme_report +
#   caption_left
# savefig(basename="fig_pdtrend_box", width=8, height=8, scale=1)

p <- pdata %>%
  mutate(stname=stname(stabbr)) %>%
  ggplot(aes(x=pdtrend, y=reorder(stname, pdtrend, IQR, na.rm=TRUE))) +
  geom_boxplot(width=0.5, 
               lwd=.2, 
               outlier.size=.75,
               notch=FALSE, 
               fill="blue", 
               outlier.colour="blue",
               alpha=.2) +
  geom_vline(xintercept = 0) +
  labs(x="percentage", y=NULL) +
  coord_cartesian(xlim=c(-truncate, truncate)) +
  scale_x_continuous(breaks=seq(-2, 2, .1),
                     labels = label_percent(accuracy=1)#,
                     #limits=c(-truncate, truncate)
  ) +
  # scale_x_break(c(.65, 1.3)) +
  # scale_x_break(c(-.58, -.38)) +
  ggtitle("State tax revenue percent deviation from trend, 2000-2020",
          subtitle="Ranked by interquartile range of deviation") +
  labs(caption=glue("Note: horizontal axis truncated at +/- {percent(truncate, accuracy=1)}.")) +
  theme_report +
  caption_left
p

savefig(basename="fig_pdtrend_box_corrected", width=8, height=8, scale=1)

```

```{r tab_states_vol}
tabdata1 <- volall %>%
  filter(period=="2000-2020",
         realnom=="nominal",
         name %in% c(taxnames$name, "gdp"),
         stabbr != "US") %>%
  select(stabbr, name, period, pdtrendiqr) %>%
  pivot_wider(values_from = pdtrendiqr) 

tabdata2 <- tabdata1 %>%
  left_join(taxshares %>%
              filter(year==2020) %>%
              select(stabbr, iitshare=iit, sevtaxshare=sevtax),
              by = "stabbr") %>%
  mutate(stname=stname(stabbr)) %>%
  select(stname, tottax, gdp, iit, gst, selsalestax, cit, sevtax, othertax,
         iitshare, sevtaxshare) %>%
  arrange(desc(tottax))

tabdata3 <- tabdata2 %>%
  summarise(across(-stname, ~median(.x, na.rm=TRUE)), .groups="drop") %>%
  mutate(stname="50-state medians")

tabdata <- bind_rows(tabdata3, 
                     tibble(tottax=NA_real_), # insert blank row
                     tabdata2 %>% filter(row_number() <= 10)) %>%
  select(stname, everything())
tabdata

tab <- tabdata %>%
  gt() %>%
  tab_header(
    title = "Selected characteristics of top 10 tax-volatility states in 2000-2020"
    ) %>%
    cols_label(stname="",
               tottax=html("Total tax"),
               gdp=html("State GDP"),
               iit=html("Personal income tax"),
               gst=html("General sales tax"),
               selsalestax=html("Selective sales taxes"),
               cit=html("Corporate income tax"),
               sevtax=html("Severance taxes"),
               othertax=html("Other taxes"),
               iitshare=html("Personal income tax"),
               sevtaxshare=html("Severance taxes")) %>%
    tab_spanner(
      label = html("<br>Volatility: Interquartile range of percent deviation from trend"),
      columns = tottax:othertax
      ) %>%
    tab_spanner(
      label = "Share of tax revenue in 2020:",
      columns = c(iitshare, sevtaxshare)
      ) %>%
    fmt_percent(
      columns = -stname,
      decimals = 1) %>%
    fmt_missing(row=2, columns=everything(), missing_text="") %>%
    fmt_missing(row= c(1, 3:nrow(tabdata)), columns=everything(), missing_text="-") %>%
    tab_style(
      style = list(
        cell_fill(color = "grey95")
      ),
      locations = cells_body(
        rows=seq(3, nrow(tabdata), 2))
      ) %>%
  cols_width(
    stname ~ pct(15),
  ) %>%
  tab_options(
    table.width = pct(100),
    # row.padding = px(3)
    ) %>%
    tab_footnote(
      footnote = "High volatility likely due to policy actions. See text for details.",
      locations = cells_body(column = "stname", row=str_detect(stname, "Illinois"))
      )
tab
savetab("tab_states_vol")

```


```{r fig_pdtrend_taxgdp_scatter_decades}
count(volall, period)
pdata <- volall %>%
  filter(period %in% decades,
         realnom=="nominal",
         name %in% c("tottax", "gdp")) %>%
  select(stabbr, name, period, pdtrendiqr) %>%
  pivot_wider(values_from = pdtrendiqr)

# prepare median values for horizontal and vertical lines
mdns <- pdata %>%
  group_by(period) %>%
  summarise(mtottax=median(tottax, na.rm=TRUE),
            mgdp=median(gdp, na.rm=TRUE))
mdns # needed for text discussion
  
p <- pdata %>%
  filter(stabbr != "US") %>%
  mutate(bad=case_when(stabbr=="AK" ~ TRUE,
                       stabbr=="ND" & period=="2010-2019" ~ TRUE,
                       stabbr=="WY" & period=="1980-1989" ~ TRUE,
                       TRUE ~ FALSE)) %>%
  filter(!bad) %>%
  # mutate(movex=.0007,
  #        movey=ifelse(stabbr %in% c("MN", "MO"), .002, 0)) %>%
  ggplot(aes(gdp, tottax)) +
  # put the lines down before points and text
  geom_hline(aes(yintercept=mtottax),
             data=mdns,
             linetype="solid", size=.25, colour="darkgreen") +
  geom_vline(aes(xintercept=mgdp),
             data=mdns,
             linetype="solid", size=.25, colour="darkgreen") +
  geom_abline(slope=1, intercept=0) +
  geom_point(colour="blue", size=.5) +
  geom_text(aes(label=stabbr, x=gdp, y=tottax),
            size=1.25, colour="blue", 
            hjust=0, nudge_x = .0005) +
  scale_x_continuous(breaks=seq(0, 1, .01),
                     labels=label_percent(accuracy=1),
                     limits=c(0, NA)) +
  scale_y_continuous(breaks=seq(0, 1, .02),
                     labels=label_percent(accuracy=1)) + #,
                     # limits=c(0, .46)) +
  # scale_y_break(c(.125, .44)) +
  labs(x="State GDP volatility",
       y="State tax volatility",
       title="State tax revenue volatility and GDP volatility by decade",
       subtitle="Interquartile range of % deviation from trend") +
  facet_wrap(~period, ncol=2, scales="free") +
  theme_report
p

savefig(basename="fig_pdtrend_taxgdp_scatter_decades", width=6, height=8, scale=1.0)
```

